<!DOCTYPE html>
<html>
<head>
  <title>DBMNG Test Api</title>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
  <script type="text/javascript" src="../src/Class.js"></script>
  <script type="text/javascript" src="../src/Dbmng.js"></script> 
  <script type="text/javascript" src="../src/Api.js"></script>
  <script type="text/javascript" src="../src/Form.js"></script> 
  <script type="text/javascript" src="../src/Ie9.js"></script> 
  <script type="text/javascript" src="../src/Utilities.js"></script>
  <script type="text/javascript" src="../src/themes/AbstractTheme.js"></script>
  <script type="text/javascript" src="../src/themes/BootstrapTheme.js"></script>
  <script type="text/javascript" src="../src/widgets/AbstractWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/SelectWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/NumericWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/PasswordWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/CheckboxWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/SelectNMWidget.js"></script>
</head>
<body>



  <h1>tabella</h1>
	<div id="test_table"></div>
  <h1>form</h1>
	<div id="test_form"></div>

	<div id="test_2"></div>




	<style>
		#test_table td{
			border:1px solid #CCC;
		}
#test_table form{
	display:block !important;
}
		#test_table input{
			border: 0px;
			background-color:#FCC;
		}

		.dbmng_col_id {
			width:6em;
		}

		#test_table form{
			display:inline!important;
		}

	</style>
	<script>

    // Test for Bootstrap theme
    var theme_boot=new Dbmng.BootstrapTheme();

    jQuery('#test_2').html(theme_boot.getTable({data:[{nm:'Diego',sr:'Guid'}]}));

    var aForm = { table_name: 'test', 
      primary_key: Array('id'), 
      fields: {
        id: {label: 'ID', type: 'int', key: 0, nullable: false}, 
        name: {label: 'Name', type: 'varchar',  nullable: false}
      }
    };

    var form=new Dbmng.Form({aForm:aForm, aParam:{}, theme:theme_boot});
    //jQuery('#test_base').append(form2.createForm(obj));

    var api=new  Dbmng.Api({aForm:aForm, url:'/dbmng2/api/test', user:'test', password:'test'});
    creaTabella('test_table');
    


function creaTabella(div_id){
  if( div_id.substring(0, 1) != '#') {
    div_id = '#' + div_id;
  }
	
	api.select({
    success:function(data){
      var aData=data.data;
      var header=[];
      for(var key in aForm.fields){
        if(aForm.fields[key].label)
          header.push(aForm.fields[key].label);	
        else{
          header.push(key);	
        }
      }
      header.push("Func.");

      var html=theme_boot.getTable({data:aData, header:header, options:{
        assignClass:true,
        setIDRow:function(aData){
          return "dbmng_row_id_"+aData.id;
        },
        addColumn:function(opt){
          console.log(header);
          var cell=theme_boot.getTableCell();

          var button_edit=jQuery(theme_boot.getButton('Edita'));
          button_edit.click(function(){
            creaForm(div_id, opt.data.id, opt.data);
          });
          jQuery(cell).append(button_edit);

          var button_edit=jQuery(theme_boot.getButton('Edita Inline'));
          button_edit.click(function(){
            creaFormInline(div_id, opt.data.id, opt.data, true);
          });		
          jQuery(cell).append(button_edit);

          var button_delete=jQuery(theme_boot.getButton('Delete'));
          button_delete.click(function(){
            deleteRecord(div_id, opt.data.id);
          });		
          jQuery(cell).append(button_delete);

          return cell;
        }
      }});
      jQuery(div_id).html(html);


      var button_insert=jQuery(theme_boot.getButton('Inserisci'));
      button_insert.click(function(){						
        creaInsertForm(div_id);
      });		
      jQuery(div_id).append(button_insert);
    }
	});
}

function deleteRecord(div_id, key){
  api.delete({key:key, success:function(data){
    creaTabella(div_id);
  }});
}

function creaInsertForm(div_id, key, aData){
  jQuery(div_id).html(form.createForm());
  var button=theme_boot.getButton('Salva');
  jQuery(button).click(function(){
    api.insert({key:key,data:form.getValue(),success:function(data){
      jQuery(div_id).html('');
      creaTabella(div_id);
    }});
  });
  jQuery(div_id).append(button);
}

function creaForm(div_id, key, aData){
  jQuery(div_id).html(form.createForm(aData));
  var button=theme_boot.getButton('Salva');
  jQuery(button).click(function(){
    api.update({key:key,data:form.getValue(),success:function(data){
      jQuery(div_id).html('');
      creaTabella(div_id);
    }});
  });
  jQuery(div_id).append(button);
}

//the function insert the form widgets inline in the table
function creaFormInline(div_id, key, aData){
  jQuery('button').attr('disabled','true');

  //get the form
  var html=form.createForm(aData);

  //define the row_id
  var row_id= div_id + ' table #dbmng_row_id_'+key;
  console.log("creaFormInline:" + row_id);

  //get the original dimension of the table
  var listWidth = [];
  jQuery(row_id+" td").each(function() {
      listWidth.push($(this).width());
  });

  //Complicato metodo per eliminare il form senza eliminare i value degli input
  var fields=html.childNodes;
  var row=document.getElementById('dbmng_row_id_'+key);
  //delete all cells
  while (row.firstChild) {
      row.removeChild(row.firstChild);
  }
  while (fields.length > 0) {
      var td=document.createElement('td');
      td.className='dbmng_cell_inline';			
      td.appendChild(fields[0]);
      row.appendChild(td);
  }

    //jQuery(row_id).html(html);
  jQuery(row_id).find('label').hide();


  //change the field dimension using the td width
  jQuery(row_id+" td.dbmng_cell_inline").each(function(k,v){
    jQuery(v).width(listWidth[k]);
    jQuery(v).find('input').width(listWidth[k]);
    jQuery(v).find('select').width(listWidth[k]);
  });


  var button=theme_boot.getButton('Salva');
  jQuery(button).click(function(){
    api.update({key:key,data:form.getValue(),success:function(data){
      jQuery('button').removeAttr('disabled');
      jQuery(div_id).html('');
      creaTabella(div_id);					
    }});
  });
  jQuery(row_id).append("<td class='dbmng_buttons'></td>");
  jQuery(row_id+' td.dbmng_buttons').html(button);
}

  </script>
</body>
