<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>DBMNG Test Api</title>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
  <script type="text/javascript" src="../src/Class.js"></script>
  <script type="text/javascript" src="../src/Dbmng.js"></script> 
  <script type="text/javascript" src="../src/Api.js"></script>
  <script type="text/javascript" src="../src/Form.js"></script> 
  <script type="text/javascript" src="../src/Crud.js"></script> 
  <script type="text/javascript" src="../src/Ie9.js"></script> 
  <script type="text/javascript" src="../src/Utilities.js"></script>
  <script type="text/javascript" src="../src/themes/AbstractTheme.js"></script>
  <script type="text/javascript" src="../src/themes/BootstrapTheme.js"></script>
  <script type="text/javascript" src="../src/widgets/AbstractWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/SelectWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/NumericWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/PasswordWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/CheckboxWidget.js"></script>
  <script type="text/javascript" src="../src/widgets/SelectNMWidget.js"></script>
</head>
<body>



  <h1>tabella: test</h1>
	<div id="test_table"></div>
  <h1>tabella: test_child</h1>
  <div id="test_child"></div>

	<div id="test_2"></div>




	<style>
		#test_table td{
			border:1px solid #CCC;
		}
#test_table form{
	display:block !important;
}
		#test_table input{
			border: 0px;
			background-color:#FCC;
		}

		.dbmng_col_id {
			width:6em;
		}

		.dbmng_col_sex {
			width:6em;
		}

		#test_table form{
			display:inline!important;
		}

	</style>
	<script>

    // Test for Bootstrap theme
    var theme_boot=new Dbmng.BootstrapTheme();

    jQuery('#test_2').html(theme_boot.getTable({data:[{nm:'Diego',sr:'Guid'}]}));
    
    /* ------------
       TABLE: test
    ---------------*/
    var aForm = { table_name: 'test', 
      primary_key: Array('id'), 
      fields: {
        id: {label: 'ID1', type: 'int', key: 0, nullable: false}, 
        name: {label: 'Name1', type: 'varchar',  nullable: false},
        sex: {label: 'Sex', type: 'varchar',  widget: 'select', voc_val: {'M':'Male', 'F':'Female'}},
        true_false: {label: 'E vero o è falso', type: 'integer',  widget: 'checkbox',voc_val: {'1':'è Vero!', '0':'Falso',null:'Boh'}}
      }
    };


		var crud=new Dbmng.Crud({aForm:aForm, aParam:{}, theme:theme_boot,url:'/dbmng2/api/test', user:'test', password:'test'});
		

		crud.createTable({div_id:'#test_table'});


    //var form=new Dbmng.Form({aForm:aForm, aParam:{}, theme:theme_boot});

    //var api1=new  Dbmng.Api({aForm:aForm, url:'/dbmng2/api/test', user:'test', password:'test'});
    //creaTabella(api1, '#test_table');

//     /* ------------
//        TABLE: test_child
//     ---------------*/
/*
    var aCForm = { table_name: 'test_child', 
      primary_key: Array('id_child'), 
      fields: {
        id_child: {label: 'ID', type: 'int', key: 0, nullable: false}, 
        child_name: {label: 'Child Name', type: 'varchar',  nullable: false}
      }
    };

    var childform = new Dbmng.Form({aForm:aCForm, aParam:{}, theme:theme_boot});

    var childapi  = new  Dbmng.Api({aForm:aCForm, url:'/dbmng2/api/test_child', user:'test', password:'test'});
    creaTabella(childapi, '#test_child');

*/
/*
function creaTabella(api, div_id){
  if( div_id.substring(0, 1) != '#') {
    div_id = '#' + div_id;
  }
	
	api.select({
    success:function(data){
			console.log(data);
      var aData=data.data;
      var header=[];
      for(var key in api.aForm.fields){
        if(api.aForm.fields[key].label)
          header.push(api.aForm.fields[key].label);	
        else{
          header.push(key);	
        }
      }
      header.push("Func.");
      
      
      var cData = form.convert2html(aData);

			console.log(aData);
      var html=theme_boot.getTable({data:cData, header:header, options:{
        assignClass:true,
        setIDRow:function(aData){
          return "dbmng_row_id_"+aData.id;
        },
        addColumn:function(opt){
          //console.log(header);
          var cell=theme_boot.getTableCell();

          var button_edit=jQuery(theme_boot.getButton('Edita مرحبا'));
          button_edit.click(function(){
            creaForm(api, div_id, opt.data.id, aData);
          });
          jQuery(cell).append(button_edit);

          var button_edit=jQuery(theme_boot.getButton('Edita Inline'));
          button_edit.click(function(){
            creaFormInline(api, div_id, opt.data.id, aData, true);
          });		
          jQuery(cell).append(button_edit);

          var button_delete=jQuery(theme_boot.getButton('Delete'));
          button_delete.click(function(){
            deleteRecord(api, div_id, aData);
          });		
          jQuery(cell).append(button_delete);

          return cell;
        }
      }});
      jQuery(div_id).html(html);

			

      var button_insert=jQuery(theme_boot.getButton('Inserisci'));
      button_insert.click(function(){
        creaInsertForm(api, div_id);
      });		
      jQuery(div_id).append(button_insert);
    }
	});
}
*/
/*
function deleteRecord(api, div_id, key){
  api.delete({key:key, success:function(data){
    creaTabella(api, div_id);
  }});
}
*/

function creaInsertForm(api, div_id, key){
  jQuery(div_id).html(form.createForm());
  var button=theme_boot.getButton('Salva');
  jQuery(button).click(function(){
    api.insert({key:key,data:form.getValue(),success:function(data){
      jQuery(div_id).html('');
      creaTabella(api, div_id);
    }});
  });
  jQuery(div_id).append(button);
}

function creaForm(api, div_id, key, aData){

	var aRecord = getARecord(key,aData);

  jQuery(div_id).html(form.createForm(aRecord));
  var button=theme_boot.getButton('Salva');
  jQuery(button).click(function(){
    api.update({key:key,data:form.getValue(),success:function(data){
      jQuery(div_id).html('');
      creaTabella(api, div_id);
    }});
  });
  jQuery(div_id).append(button);
}

//the function insert the form widgets inline in the table
function creaFormInline(api, div_id, key, aData){

	var aRecord=getARecord(key,aData);
  jQuery('button').attr('disabled','true');

  //get the form
  var html=form.createForm(aRecord);

  //define the row_id
  var row_id= div_id + ' table #dbmng_row_id_'+key;

  //get the original dimension of the table
  var listWidth = [];
  jQuery(row_id+" td").each(function() {
      listWidth.push($(this).width());
  });

  //Complicato metodo per eliminare il form senza eliminare i value degli input
  var fields=html.childNodes;
  var row=document.getElementById('dbmng_row_id_'+key);
  //delete all cells
  while (row.firstChild) {
      row.removeChild(row.firstChild);
  }
  while (fields.length > 0) {
      var td=document.createElement('td');
      td.className='dbmng_cell_inline';			
      td.appendChild(fields[0]);
      row.appendChild(td);
  }

    //jQuery(row_id).html(html);
  jQuery(row_id).find('label').hide();


  //change the field dimension using the td width
  jQuery(row_id+" td.dbmng_cell_inline").each(function(k,v){
    jQuery(v).width(listWidth[k]);
    jQuery(v).find('input').width(listWidth[k]);
    jQuery(v).find('select').width(listWidth[k]);
  });


  var button=theme_boot.getButton('Salva');
  jQuery(button).click(function(){
    api.update({key:key,data:form.getValue(),success:function(data){
      jQuery('button').removeAttr('disabled');
      jQuery(div_id).html('');
      creaTabella(api, div_id);
    }});
  });
  jQuery(row_id).append("<td class='dbmng_buttons'></td>");
  jQuery(row_id+' td.dbmng_buttons').html(button);
}


function getARecord(key,aData){
	var aRecord=null;
	for(var i=0; i<aData.length; i++){
		if(aData[i]['id']==key){
			aRecord=aData[i];
			break;
		}
	}
	return aRecord;
}

  </script>
</body>
